// This file has been autogenerated from a class added in the UI designer.

using System;
using System.Collections.Generic;
using System.Linq;
using CoreGraphics;
using Foundation;
using OMAPGMap.Models;
using UIKit;

namespace OMAPGMap.iOS
{
	public partial class SettingsViewController : UITableViewController
	{
        public SettingsViewController(IntPtr ptr) : base(ptr)
        {
            
        }

        private List<int> TrashAdded = new List<int>();
        private List<int> TrashRemoved = new List<int>();
        private UITextField DistInput = null;
        private UIView HeaderView = null;
        private nint SelectedGen = 0;
        private int gen2start = 152;
        private int gen3start = 252;

        public ViewController ParentVC { get; set; }

        public override void ViewDidLoad()
        {
            base.ViewDidLoad();
            Title = "Map Settings";
            NavigationItem.LeftBarButtonItem = new UIBarButtonItem("Done", UIBarButtonItemStyle.Done, (sender, e) =>
            {
                if(TrashAdded.Count > 0)
                {
                    ParentVC.TrashAdded(TrashAdded);
                }
                if(TrashRemoved.Count > 0)
                {
                    ParentVC.TrashRemoved(TrashRemoved);
                }
                if (DistInput != null)
                {
                    ServiceLayer.SharedInstance.Settings.NotifyDistance = int.Parse(DistInput.Text);
                }
                ParentVC.ApplySettings();
                DismissViewController(true, null);
                var app = UIApplication.SharedApplication.Delegate as AppDelegate;
                app.UpdateDeviceData();
            });
            HeaderView = TableView.TableHeaderView;
            TableView.TableHeaderView = new UIView();
        }

        public override nint NumberOfSections(UITableView tableView)
        {
            return 2;
        }

        //public override string TitleForHeader(UITableView tableView, nint section)
        //{
        //    return section == 0 ? "Settings" : "Pokemon Settings";
        //}

        public override UIView GetViewForHeader(UITableView tableView, nint section)
        {
            if(section == 0)
            {
                return new UIView();
            }
            else 
            {
                return HeaderView;
            }
        }

        public override nfloat GetHeightForHeader(UITableView tableView, nint section)
        {
            return section == 0 ? 1.0f : 70.0f;
        }

        public override UITableViewCell GetCell(UITableView tableView, NSIndexPath indexPath)
        {
            
            if (indexPath.Section == 0)
            {
                UITableViewCell cell = null;
                if(indexPath.Row < 4)
                {
                    cell = tableView.DequeueReusableCell("ResetTrashCell", indexPath);
                }
                var label = cell?.ViewWithTag(1) as UILabel;
                switch(indexPath.Row)
                {
                    case 0:
                        label.Text = "Hide Everything";
                        break;
                    case 1:
                        label.Text = "Reset Default Hidden";
                        break;
                    case 2:
                        label.Text = "Save Current Hidden";
                        break;
                    case 3:
                        label.Text = "Recall Saved Hidden";
                        break;
                    case 4:
                        cell = tableView.DequeueReusableCell("AllNotifyCell", indexPath);
                        var s = cell.ViewWithTag(2) as UISwitch;
                        label = cell.ViewWithTag(1) as UILabel;
                        label.Text = "All Notifications";
                        s.On = ServiceLayer.SharedInstance.Settings.NotifyEnabled;
                        break;
                    case 5:
                        cell = tableView.DequeueReusableCell("AllNotifyCell", indexPath);
                        var s1 = cell.ViewWithTag(2) as UISwitch;
                        label = cell.ViewWithTag(1) as UILabel;
                        label.Text = "> 90% IV Notify";
                        s1.On = ServiceLayer.SharedInstance.Settings.Notify90Enabled;
                        label.TextColor = ServiceLayer.SharedInstance.Settings.NotifyEnabled ? UIColor.Black : UIColor.Gray;
                        s1.Enabled = ServiceLayer.SharedInstance.Settings.NotifyEnabled;
                        break;
                    case 6:
                        cell = tableView.DequeueReusableCell("AllNotifyCell", indexPath);
                        var s2 = cell.ViewWithTag(2) as UISwitch;
                        label = cell.ViewWithTag(1) as UILabel;
                        label.Text = "100% IV Notify";
                        s2.On = ServiceLayer.SharedInstance.Settings.Notify100Enabled;
                        label.TextColor = ServiceLayer.SharedInstance.Settings.NotifyEnabled ? UIColor.Black : UIColor.Gray;
                        s2.Enabled = ServiceLayer.SharedInstance.Settings.NotifyEnabled;
                        break;
                    case 7:
                        cell = tableView.DequeueReusableCell("NotifyDistanceCell", indexPath);
                        var input = cell.ViewWithTag(2) as UITextField;
                        if(DistInput == null)
                        {
                            DistInput = input;
                            input.ValueChanged += (sender, e) =>
                            {
                                ServiceLayer.SharedInstance.Settings.NotifyDistance = int.Parse(DistInput.Text);
                            };
                            var tool = new UIToolbar();
                            tool.SizeToFit();
                            var done = new UIBarButtonItem("Done", UIBarButtonItemStyle.Done, (sender, e) =>
                            {
                                ServiceLayer.SharedInstance.Settings.NotifyDistance = int.Parse(DistInput.Text);
                                DistInput.ResignFirstResponder();
                            });
                            tool.SetItems(new UIBarButtonItem[] { done }, false);
                            DistInput.InputAccessoryView = tool;
                        }
                        label = cell.ViewWithTag(1) as UILabel;
                        input.Text = ServiceLayer.SharedInstance.Settings.NotifyDistance.ToString();
                        label.TextColor = ServiceLayer.SharedInstance.Settings.NotifyEnabled ? UIColor.Black : UIColor.Gray;
                        input.Enabled = ServiceLayer.SharedInstance.Settings.NotifyEnabled;
                        break;
                    case 8:
                        cell = tableView.DequeueReusableCell("AllNotifyCell", indexPath);
                        var s3 = cell.ViewWithTag(2) as UISwitch;
                        label = cell.ViewWithTag(1) as UILabel;
                        label.Text = "Legendary Raids";
                        s3.On = ServiceLayer.SharedInstance.Settings.LegondaryRaids;
                        break;
                    case 9:
                        cell = tableView.DequeueReusableCell("AllNotifyCell", indexPath);
                        var s4 = cell.ViewWithTag(2) as UISwitch;
                        label = cell.ViewWithTag(1) as UILabel;
                        label.Text = "Level 4 Raids";
                        s4.On = ServiceLayer.SharedInstance.Settings.Level4Raids;
                        break;
                    case 10:
                        cell = tableView.DequeueReusableCell("AllNotifyCell", indexPath);
                        var s5 = cell.ViewWithTag(2) as UISwitch;
                        label = cell.ViewWithTag(1) as UILabel;
                        label.Text = "Level 3 Raids";
                        s5.On = ServiceLayer.SharedInstance.Settings.Level3Raids;
                        break;
                    case 11:
                        cell = tableView.DequeueReusableCell("AllNotifyCell", indexPath);
                        var s6 = cell.ViewWithTag(2) as UISwitch;
                        label = cell.ViewWithTag(1) as UILabel;
                        label.Text = "Level 2 Raids";
                        s6.On = ServiceLayer.SharedInstance.Settings.Level2Raids;
                        break;
                    case 12:
                        cell = tableView.DequeueReusableCell("AllNotifyCell", indexPath);
                        var s7 = cell.ViewWithTag(2) as UISwitch;
                        label = cell.ViewWithTag(1) as UILabel;
                        label.Text = "Level 1 Raids";
                        s7.On = ServiceLayer.SharedInstance.Settings.Level1Raids;
                        break;
                }
                return cell;
            }



            else
            {
                var cell = tableView.DequeueReusableCell("FilterCell", indexPath);
                var img = cell.ViewWithTag(1) as UIImageView;
                var notifyLbl = cell.ViewWithTag(2) as UILabel;
                var notifySwitch = cell.ViewWithTag(3) as UISwitch;
                var trashLbl = cell.ViewWithTag(4) as UILabel;
                var trashSwitch = cell.ViewWithTag(5) as UISwitch;
                var pokemonid = ConvertRowToID(indexPath.Row);

                img.Image = UIImage.FromBundle(pokemonid.ToString("D3"));
                if (!ServiceLayer.SharedInstance.Settings.PokemonHidden.Contains(pokemonid))
                {
                    img.Alpha = 1.0f;
                    notifyLbl.TextColor = UIColor.Black;
                    trashLbl.TextColor = UIColor.Black;
                    trashSwitch.Enabled = true;
                    trashSwitch.On = ServiceLayer.SharedInstance.Settings.PokemonTrash.Contains(pokemonid);
                    notifySwitch.Enabled = true;
                    notifySwitch.On = ServiceLayer.SharedInstance.Settings.NotifyPokemon.Contains(pokemonid);
                }
                else
                {
                    img.Alpha = 0.7f;
                    notifyLbl.TextColor = UIColor.LightGray;
                    trashLbl.TextColor = UIColor.LightGray;
                    trashSwitch.Enabled = false;
                    trashSwitch.On = false;
                    notifySwitch.Enabled = false;
                    notifySwitch.On = false;
                }
                cell.SelectionStyle = UITableViewCellSelectionStyle.None;
                return cell;
            }
        }

        public override nint RowsInSection(UITableView tableView, nint section)
        {
            if (section == 0)
            {
                return 13;
            }
            else
            {
                var numPokes = 0;
                switch (SelectedGen)
                {
                    case 0:
                        numPokes = 151;
                        break;
                    case 1:
                        numPokes = 100;
                        break;
                    case 2:
                        numPokes = 134;
                        break;
                }
                return numPokes;
            }
        }

        partial void TrashToggled(NSObject sender)
        {
            var trashSwitch = sender as UISwitch;
            var cell = trashSwitch.Superview.Superview as UITableViewCell;
            if (cell != null)
            {
                var path = TableView.IndexPathForCell(cell);
                var pokemonid = ConvertRowToID(path.Row);
                if(trashSwitch.On)
                {
                    TrashAdded.Add(pokemonid);
                    TrashRemoved.Remove(pokemonid);
                    ServiceLayer.SharedInstance.Settings.PokemonTrash.Add(pokemonid);
                } else 
                {
                    TrashRemoved.Add(pokemonid);
                    TrashAdded.Remove(pokemonid);
                    ServiceLayer.SharedInstance.Settings.PokemonTrash.Remove(pokemonid);
                }
            }
        }

        partial void NotifyToggled(NSObject sender)
        {
            var notifySwitch = sender as UISwitch;
            var cell = notifySwitch.Superview.Superview as UITableViewCell;
            if (cell != null)
            {
                var path = TableView.IndexPathForCell(cell);
                var pokemonid = ConvertRowToID(path.Row);
                if (notifySwitch.On)
                {
                    ServiceLayer.SharedInstance.Settings.NotifyPokemon.Add(pokemonid);
                }
                else
                {
                    ServiceLayer.SharedInstance.Settings.NotifyPokemon.Remove(pokemonid);
                }
            }
        }

        public override void RowSelected(UITableView tableView, NSIndexPath indexPath)
        {
            switch(indexPath.Row)
            {
                case 0: //hide everythings
                    for (var i = 0; i < ServiceLayer.NumberPokemon; i++)
					{
                        var i2 = ConvertRowToID(i);
                        TrashRemoved.Clear();
                        if (!ServiceLayer.SharedInstance.Settings.PokemonTrash.Contains(i2) && !TrashAdded.Contains(i2))
						{
							TrashAdded.Add(i2);
                            ServiceLayer.SharedInstance.Settings.PokemonTrash.Add(i2);
						}
					}
					
                    TableView.ReloadData();
                    break;
                case 1: //reset trash
                    var trashCopy = new List<int>(ServiceLayer.SharedInstance.Settings.PokemonTrash);
                    ServiceLayer.SharedInstance.Settings.ResetTrash();
                    for (var i = 0; i < ServiceLayer.NumberPokemon; i++)
					{
                        var i2 = ConvertRowToID(i);
                        if (ServiceLayer.SharedInstance.Settings.PokemonTrash.Contains(i2) && !trashCopy.Contains(i2))
						{
							TrashAdded.Add(i2);
                            TrashRemoved.Remove(i2);
						}
                        else if (!ServiceLayer.SharedInstance.Settings.PokemonTrash.Contains(i2) && trashCopy.Contains(i2))
						{
							TrashRemoved.Add(i2);
                            TrashAdded.Remove(i2);
						}
					}
                    ServiceLayer.SharedInstance.Settings.ResetTrash();
					TableView.ReloadData();
                    break;
                case 2: //save current trash
                    var trashStrings = ServiceLayer.SharedInstance.Settings.PokemonTrash.Select(t => t.ToString()).ToArray();
					var tosave = NSArray.FromStrings(trashStrings);
					NSUserDefaults.StandardUserDefaults.SetValueForKey(tosave, new NSString("trashSaved"));
                    break;
                case 3: //recall saved trash
					var trash = NSUserDefaults.StandardUserDefaults.StringArrayForKey("trashSaved");
					if (trash != null)
					{
						var trashInt = trash.Select(l => int.Parse(l));
                        for (var i = 0; i < ServiceLayer.NumberPokemon; i++)
                        {
                            if (!ServiceLayer.SharedInstance.Settings.PokemonTrash.Contains(i) && trashInt.Contains(i))
							{
								TrashAdded.Add(i);
                                TrashRemoved.Remove(i);
							}
                            else if (ServiceLayer.SharedInstance.Settings.PokemonTrash.Contains(i) && !trashInt.Contains(i))
							{
								TrashRemoved.Add(i);
                                TrashAdded.Remove(i);
							}
                        }
						ServiceLayer.SharedInstance.Settings.PokemonTrash.Clear();
                        ServiceLayer.SharedInstance.Settings.PokemonTrash.AddRange(trashInt);
						TableView.ReloadData();
					}
                    break;
            }
            tableView.DeselectRow(indexPath, true);
        }

        private int ConvertRowToID(int row)
        {
            var rval = row+1;
            switch (SelectedGen)
            {
                case 1:
                    rval = row + gen2start;
                    break;
                case 2:
                    rval = row + gen3start;
                    break;
            }
            return rval;
        }

        partial void SettingToggled(NSObject sender)
        {
            var toggle = sender as UISwitch;
            var cell = toggle.Superview.Superview as UITableViewCell;
            if (cell != null)
            {
                var path = TableView.IndexPathForCell(cell);
                if(path.Row == 4)
                {
                    ServiceLayer.SharedInstance.Settings.NotifyEnabled = toggle.On;
                } else if(path.Row == 5)
                {
                    ServiceLayer.SharedInstance.Settings.Notify90Enabled = toggle.On;
                } else if(path.Row == 6)
                {
                    ServiceLayer.SharedInstance.Settings.Notify100Enabled = toggle.On;
                }else if (path.Row == 8)
                {
                    ServiceLayer.SharedInstance.Settings.LegondaryRaids = toggle.On;
                } else if (path.Row == 9)
                {
                    ServiceLayer.SharedInstance.Settings.Level4Raids = toggle.On;
                } else if (path.Row == 10)
                {
                    ServiceLayer.SharedInstance.Settings.Level3Raids = toggle.On;
                } else if (path.Row == 11)
                {
                    ServiceLayer.SharedInstance.Settings.Level2Raids = toggle.On;
                } else if (path.Row == 12)
                {
                    ServiceLayer.SharedInstance.Settings.Level1Raids = toggle.On;
                }

            }
            TableView.ReloadData();
        }

        partial void GenerationSelected(NSObject sender)
        {
            var seg = sender as UISegmentedControl;
            SelectedGen = seg.SelectedSegment;
            TableView.ReloadData();
        }
	}
}
